# Wallet Model - Detailed Specification

## Overview

The **Wallet** model represents a financial account within the Rachel Foods platform. Wallets are the fundamental units of money storage and transfer, with **balances computed dynamically** from the immutable ledger.

---

## Model Definition

```prisma
model Wallet {
  id            String       @id @default(uuid())

  // Owner identification
  // userId can be null for system wallets (platform, escrow)
  userId        String?
  user          User?        @relation(fields: [userId], references: [id])

  // Wallet classification
  walletType    WalletType   // USER, PLATFORM, or ESCROW
  walletStatus  WalletStatus @default(ACTIVE)

  // System wallet identification
  // Used for platform/escrow wallets that don't have a userId
  walletCode    String?      @unique // e.g., 'PLATFORM_MAIN', 'ESCROW_COD'

  // NO STORED BALANCE FIELD
  // Balance is ALWAYS computed from LedgerEntry.amount sums

  // Metadata
  currency      String       @default("INR")

  // Security
  freezeReason  String?      // Why wallet was frozen (if status = FROZEN)
  frozenAt      DateTime?    // When wallet was frozen
  frozenBy      String?      // Admin user ID who froze wallet

  // Audit
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // Relations
  ledgerEntries LedgerEntry[]
  paymentsSent  Payment[]    @relation("PayerWallet")
  paymentsReceived Payment[] @relation("PayeeWallet")
  refundsIssued Refund[]     @relation("RefundIssuerWallet")
  refundsReceived Refund[]   @relation("RefundRecipientWallet")

  // Constraints
  @@unique([userId, walletType]) // One wallet of each type per user
  @@index([userId])
  @@index([walletCode])
  @@index([walletType])
  @@map("wallets")
}
```

---

## Field Specifications

### `id` - Primary Key

- **Type**: UUID
- **Purpose**: Unique identifier for this wallet
- **Generation**: Auto-generated by Prisma
- **Immutable**: Never changes after creation

### `userId` - User Owner (Optional)

- **Type**: String (UUID) or null
- **Purpose**: Links wallet to its owner
- **Required**: Yes for USER wallets, No for PLATFORM/ESCROW wallets
- **Indexed**: Yes (for user wallet lookup)
- **Foreign Key**: References `User.id`
- **Constraint**: `(userId, walletType)` must be unique

**Examples**:

```typescript
// User wallet
{ userId: 'user-abc123', walletType: 'USER', walletCode: null }

// Platform wallet (no user)
{ userId: null, walletType: 'PLATFORM', walletCode: 'PLATFORM_MAIN' }

// Escrow wallet (no user)
{ userId: null, walletType: 'ESCROW', walletCode: 'ESCROW_COD' }
```

### `walletType` - Wallet Classification

- **Type**: Enum `WalletType`
- **Purpose**: Defines the purpose and ownership of wallet
- **Required**: Yes
- **Indexed**: Yes

**Enum Values**:

```prisma
enum WalletType {
  USER      // Personal wallet (buyer or seller)
  PLATFORM  // Rachel Foods platform wallet
  ESCROW    // Temporary holding wallet (future use)
}
```

**Type Characteristics**:

| Type     | userId   | walletCode | Purpose        | Balance Source       |
| -------- | -------- | ---------- | -------------- | -------------------- |
| USER     | Required | Null       | Personal funds | User transactions    |
| PLATFORM | Null     | Required   | Platform fees  | Fee collection       |
| ESCROW   | Null     | Required   | Holding funds  | Pending transactions |

### `walletStatus` - Account Status

- **Type**: Enum `WalletStatus`
- **Purpose**: Controls wallet operations
- **Default**: ACTIVE
- **Required**: Yes

**Enum Values**:

```prisma
enum WalletStatus {
  ACTIVE    // Normal operations allowed
  SUSPENDED // Temporary restriction (e.g., verification pending)
  FROZEN    // Locked by admin (security/fraud)
  CLOSED    // Permanently closed (cannot reopen)
}
```

**Status Behaviors**:

| Status    | Can Send | Can Receive | Can View      |
| --------- | -------- | ----------- | ------------- |
| ACTIVE    | ‚úÖ Yes   | ‚úÖ Yes      | ‚úÖ Yes        |
| SUSPENDED | ‚ùå No    | ‚úÖ Yes      | ‚úÖ Yes        |
| FROZEN    | ‚ùå No    | ‚ùå No       | ‚ö†Ô∏è Owner only |
| CLOSED    | ‚ùå No    | ‚ùå No       | ‚ö†Ô∏è Owner only |

### `walletCode` - System Wallet Identifier

- **Type**: String or null
- **Purpose**: Unique identifier for non-user wallets
- **Required**: Yes for PLATFORM/ESCROW, No for USER
- **Unique**: Yes (database constraint)
- **Indexed**: Yes

**Predefined Codes**:

- `PLATFORM_MAIN` - Primary platform wallet for fees
- `ESCROW_COD` - COD escrow wallet (future use)
- `ESCROW_PREPAID` - PREPAID escrow wallet (future use)

**Example**:

```typescript
// Find platform wallet
const platformWallet = await prisma.wallet.findUnique({
  where: { walletCode: 'PLATFORM_MAIN' },
});
```

### `currency` - Wallet Currency

- **Type**: String
- **Purpose**: Wallet currency (ISO 4217 code)
- **Default**: "INR" (Indian Rupee)
- **Required**: Yes
- **Note**: Sprint 6A only supports INR (multi-currency future)

### `freezeReason` - Freeze Explanation

- **Type**: String or null
- **Purpose**: Human-readable reason for freezing wallet
- **Required**: Only when status = FROZEN
- **Max Length**: 1000 characters (recommended)
- **Example**: `"Suspected fraudulent activity - Order #123 investigation"`

### `frozenAt` - Freeze Timestamp

- **Type**: DateTime or null
- **Purpose**: When wallet was frozen
- **Set**: Automatically when status ‚Üí FROZEN
- **Cleared**: When status changes to ACTIVE/SUSPENDED

### `frozenBy` - Freeze Admin

- **Type**: String (User ID) or null
- **Purpose**: Admin who froze the wallet
- **Required**: Only when status = FROZEN
- **Audit**: Critical for compliance

### `createdAt` - Creation Timestamp

- **Type**: DateTime
- **Purpose**: When wallet was created
- **Auto-generated**: Yes
- **Immutable**: Never changes

### `updatedAt` - Last Modification

- **Type**: DateTime
- **Purpose**: When wallet was last updated
- **Auto-updated**: Yes (Prisma middleware)
- **Note**: Balance changes do NOT update this (balance is ledger-derived)

---

## Balance Calculation (Critical)

### The Golden Rule

**Wallet balance is NEVER stored. It is ALWAYS computed from LedgerEntry sums.**

```typescript
// WalletService method
async getWalletBalance(walletId: string): Promise<Decimal> {
  const result = await this.prisma.ledgerEntry.aggregate({
    where: { walletId },
    _sum: { amount: true },
  });

  return result._sum.amount || new Decimal(0);
}
```

### Why This Approach?

| Approach                         | Pros                            | Cons                                          |
| -------------------------------- | ------------------------------- | --------------------------------------------- |
| **Stored Balance** (‚ùå Not used) | Fast reads                      | Race conditions, sync issues, data corruption |
| **Ledger-Derived** (‚úÖ Used)     | Always accurate, no sync issues | Slightly slower reads                         |

**Performance Trade-off**:

- Query time: ~10-50ms (with proper indexes)
- Accuracy: 100% guaranteed
- Caching: Can cache for 5 minutes if needed

### Balance Query Optimization

```typescript
// With index on (walletId, createdAt)
const balance = await prisma.ledgerEntry.aggregate({
  where: { walletId },
  _sum: { amount: true },
});

// Use read replica for high traffic
const balance = await replicaPrisma.ledgerEntry.aggregate({
  where: { walletId },
  _sum: { amount: true },
});
```

---

## Wallet Lifecycle

### 1. Wallet Creation

**USER Wallet** (Created on user registration):

```typescript
async createUserWallet(userId: string): Promise<Wallet> {
  return await this.prisma.wallet.create({
    data: {
      userId,
      walletType: WalletType.USER,
      walletStatus: WalletStatus.ACTIVE,
      currency: 'INR',
    },
  });
}
```

**PLATFORM Wallet** (Created on system initialization):

```typescript
async createPlatformWallet(): Promise<Wallet> {
  return await this.prisma.wallet.create({
    data: {
      userId: null,
      walletType: WalletType.PLATFORM,
      walletCode: 'PLATFORM_MAIN',
      walletStatus: WalletStatus.ACTIVE,
      currency: 'INR',
    },
  });
}
```

**ESCROW Wallet** (Created for specific transaction types):

```typescript
async createEscrowWallet(code: string): Promise<Wallet> {
  return await this.prisma.wallet.create({
    data: {
      userId: null,
      walletType: WalletType.ESCROW,
      walletCode: code,
      walletStatus: WalletStatus.ACTIVE,
      currency: 'INR',
    },
  });
}
```

### 2. Wallet Status Transitions

```typescript
// State machine
type StatusTransition = {
  from: WalletStatus;
  to: WalletStatus;
  allowed: boolean;
  requiresAdmin: boolean;
};

const transitions: StatusTransition[] = [
  { from: 'ACTIVE', to: 'SUSPENDED', allowed: true, requiresAdmin: false },
  { from: 'ACTIVE', to: 'FROZEN', allowed: true, requiresAdmin: true },
  { from: 'ACTIVE', to: 'CLOSED', allowed: true, requiresAdmin: false },

  { from: 'SUSPENDED', to: 'ACTIVE', allowed: true, requiresAdmin: false },
  { from: 'SUSPENDED', to: 'FROZEN', allowed: true, requiresAdmin: true },
  { from: 'SUSPENDED', to: 'CLOSED', allowed: true, requiresAdmin: false },

  { from: 'FROZEN', to: 'ACTIVE', allowed: true, requiresAdmin: true },
  { from: 'FROZEN', to: 'SUSPENDED', allowed: true, requiresAdmin: true },
  { from: 'FROZEN', to: 'CLOSED', allowed: true, requiresAdmin: true },

  { from: 'CLOSED', to: 'ACTIVE', allowed: false, requiresAdmin: false }, // CLOSED is final
];
```

### 3. Wallet Operations (by Status)

**ACTIVE Wallet**:

- ‚úÖ Send money (debit)
- ‚úÖ Receive money (credit)
- ‚úÖ View balance
- ‚úÖ View transaction history

**SUSPENDED Wallet**:

- ‚ùå Send money (blocked)
- ‚úÖ Receive money (allowed)
- ‚úÖ View balance
- ‚úÖ View transaction history
- ‚ö†Ô∏è Reason: Verification pending, document submission required

**FROZEN Wallet**:

- ‚ùå Send money (blocked)
- ‚ùå Receive money (blocked)
- ‚ö†Ô∏è View balance (owner only)
- ‚ö†Ô∏è View transaction history (owner + admin only)
- üö® Reason: Fraud investigation, legal hold, security breach

**CLOSED Wallet**:

- ‚ùå Send money (blocked)
- ‚ùå Receive money (blocked)
- ‚ö†Ô∏è View balance (read-only)
- ‚ö†Ô∏è View transaction history (read-only)
- üîí Status: Permanent (cannot reopen)

---

## Wallet Types in Detail

### USER Wallet (Personal Accounts)

**Characteristics**:

- One wallet per user (enforced by unique constraint)
- Used for buying and selling
- Balance can be positive (funds available) or negative (debt/adjustment)
- Subject to fraud detection rules

**Creation**:

```typescript
// Automatically created on user registration
@Injectable()
export class AuthService {
  async register(data: RegisterDto): Promise<User> {
    return await this.prisma.$transaction(async (tx) => {
      // 1. Create user
      const user = await tx.user.create({ data });

      // 2. Create wallet
      await tx.wallet.create({
        data: {
          userId: user.id,
          walletType: WalletType.USER,
          walletStatus: WalletStatus.ACTIVE,
        },
      });

      return user;
    });
  }
}
```

**Usage**:

```typescript
// Get user's wallet
const wallet = await prisma.wallet.findUnique({
  where: {
    userId_walletType: {
      userId: currentUser.id,
      walletType: WalletType.USER,
    },
  },
});
```

### PLATFORM Wallet (System Account)

**Characteristics**:

- Single wallet (one per platform)
- Collects platform fees
- Never belongs to a user (userId = null)
- Identified by `walletCode = 'PLATFORM_MAIN'`
- Should always have positive balance (fees accumulated)

**Creation**:

```typescript
// Created once during system initialization
async function initializePlatformWallet() {
  const existing = await prisma.wallet.findUnique({
    where: { walletCode: 'PLATFORM_MAIN' },
  });

  if (!existing) {
    await prisma.wallet.create({
      data: {
        userId: null,
        walletType: WalletType.PLATFORM,
        walletCode: 'PLATFORM_MAIN',
        walletStatus: WalletStatus.ACTIVE,
      },
    });
  }
}
```

**Usage**:

```typescript
// Reference platform wallet in transactions
const platformWallet = await prisma.wallet.findUniqueOrThrow({
  where: { walletCode: 'PLATFORM_MAIN' },
});

// Record platform fee
await prisma.ledgerEntry.create({
  data: {
    walletId: platformWallet.id,
    amount: platformFee,
    entryType: LedgerEntryType.PLATFORM_FEE_CREDIT,
    // ...
  },
});
```

### ESCROW Wallet (Holding Account)

**Characteristics**:

- Temporary holding for funds
- Used for pending transactions
- Multiple escrow wallets possible (by type)
- Identified by `walletCode` (e.g., 'ESCROW_COD')
- **Not implemented in Sprint 6A** (future use)

**Future Use Cases**:

1. **COD Escrow**: Hold funds until delivery confirmed
2. **Dispute Escrow**: Hold refund until resolution
3. **Pre-approval Escrow**: Hold funds for multi-step orders

**Example (Future)**:

```typescript
// Create COD escrow wallet
const escrowWallet = await prisma.wallet.create({
  data: {
    userId: null,
    walletType: WalletType.ESCROW,
    walletCode: `ESCROW_COD_${orderId}`,
    walletStatus: WalletStatus.ACTIVE,
  },
});

// Transfer buyer payment to escrow
// (Hold until delivery confirmed)

// After confirmation, transfer to seller
```

---

## Wallet Operations

### 1. Get Wallet Balance

```typescript
async getBalance(walletId: string): Promise<Decimal> {
  const result = await this.prisma.ledgerEntry.aggregate({
    where: { walletId },
    _sum: { amount: true },
  });

  return result._sum.amount || new Decimal(0);
}
```

### 2. Check Sufficient Funds

```typescript
async hasSufficientFunds(
  walletId: string,
  requiredAmount: Decimal,
): Promise<boolean> {
  const balance = await this.getBalance(walletId);
  return balance.gte(requiredAmount);
}
```

### 3. Freeze Wallet (Admin)

```typescript
async freezeWallet(
  walletId: string,
  reason: string,
  adminUserId: string,
): Promise<Wallet> {
  return await this.prisma.wallet.update({
    where: { id: walletId },
    data: {
      walletStatus: WalletStatus.FROZEN,
      freezeReason: reason,
      frozenAt: new Date(),
      frozenBy: adminUserId,
    },
  });
}
```

### 4. Unfreeze Wallet (Admin)

```typescript
async unfreezeWallet(walletId: string): Promise<Wallet> {
  return await this.prisma.wallet.update({
    where: { id: walletId },
    data: {
      walletStatus: WalletStatus.ACTIVE,
      freezeReason: null,
      frozenAt: null,
      frozenBy: null,
    },
  });
}
```

### 5. Suspend Wallet (Verification)

```typescript
async suspendWallet(walletId: string): Promise<Wallet> {
  return await this.prisma.wallet.update({
    where: { id: walletId },
    data: { walletStatus: WalletStatus.SUSPENDED },
  });
}
```

### 6. Close Wallet (Permanent)

```typescript
async closeWallet(walletId: string): Promise<Wallet> {
  // Check balance is zero
  const balance = await this.getBalance(walletId);

  if (!balance.equals(0)) {
    throw new BadRequestException('Cannot close wallet with non-zero balance');
  }

  return await this.prisma.wallet.update({
    where: { id: walletId },
    data: { walletStatus: WalletStatus.CLOSED },
  });
}
```

### 7. Get Wallet Details (with Balance)

```typescript
async getWalletDetails(walletId: string): Promise<WalletDetails> {
  const wallet = await this.prisma.wallet.findUniqueOrThrow({
    where: { id: walletId },
    include: { user: { select: { name: true, email: true } } },
  });

  const balance = await this.getBalance(walletId);

  return {
    ...wallet,
    balance, // Computed, not stored
  };
}
```

### 8. Get Transaction History

```typescript
async getTransactionHistory(
  walletId: string,
  options: PaginationOptions,
): Promise<PaginatedResponse<LedgerEntry>> {
  const entries = await this.prisma.ledgerEntry.findMany({
    where: { walletId },
    orderBy: { createdAt: 'desc' },
    take: options.limit,
    skip: options.offset,
    include: {
      payment: { select: { id: true, lifecycle: true } },
      order: { select: { orderNumber: true } },
      refund: { select: { id: true, status: true } },
    },
  });

  const total = await this.prisma.ledgerEntry.count({
    where: { walletId },
  });

  return { data: entries, total, page: options.page };
}
```

---

## Security & Fraud Prevention

### 1. Operation Guards

```typescript
// Check wallet status before operation
async validateWalletForDebit(walletId: string): Promise<void> {
  const wallet = await this.prisma.wallet.findUniqueOrThrow({
    where: { id: walletId },
  });

  if (wallet.walletStatus !== WalletStatus.ACTIVE) {
    throw new ForbiddenException(
      `Wallet is ${wallet.walletStatus}. Cannot perform debit operation.`,
    );
  }
}

async validateWalletForCredit(walletId: string): Promise<void> {
  const wallet = await this.prisma.wallet.findUniqueOrThrow({
    where: { id: walletId },
  });

  if ([WalletStatus.FROZEN, WalletStatus.CLOSED].includes(wallet.walletStatus)) {
    throw new ForbiddenException(
      `Wallet is ${wallet.walletStatus}. Cannot receive funds.`,
    );
  }
}
```

### 2. Negative Balance Detection

```typescript
async checkNegativeBalance(walletId: string): Promise<void> {
  const balance = await this.getBalance(walletId);

  if (balance.isNegative()) {
    // Alert admin for investigation
    await this.alertService.notifyAdmin({
      type: 'NEGATIVE_BALANCE',
      walletId,
      balance: balance.toString(),
      severity: 'HIGH',
    });

    // Optional: Auto-suspend wallet
    await this.suspendWallet(walletId);
  }
}
```

### 3. Large Transaction Detection

```typescript
const LARGE_TRANSACTION_THRESHOLD = new Decimal(10000); // ‚Çπ10,000

async validateTransactionAmount(amount: Decimal): Promise<void> {
  if (amount.gt(LARGE_TRANSACTION_THRESHOLD)) {
    // Require additional verification
    throw new BadRequestException(
      'Large transaction requires manual approval',
    );
  }
}
```

### 4. Rapid Transaction Detection

```typescript
async checkRapidTransactions(walletId: string): Promise<void> {
  const recentCount = await this.prisma.ledgerEntry.count({
    where: {
      walletId,
      createdAt: { gte: new Date(Date.now() - 60 * 1000) }, // Last 1 min
    },
  });

  if (recentCount > 10) {
    // Possible fraud/bot activity
    await this.suspendWallet(walletId);
    throw new TooManyRequestsException('Rate limit exceeded');
  }
}
```

---

## Query Patterns

### Get User's Wallet

```typescript
const wallet = await prisma.wallet.findUnique({
  where: {
    userId_walletType: {
      userId: user.id,
      walletType: WalletType.USER,
    },
  },
});
```

### Get Platform Wallet

```typescript
const platformWallet = await prisma.wallet.findUniqueOrThrow({
  where: { walletCode: 'PLATFORM_MAIN' },
});
```

### Get All Active Wallets

```typescript
const activeWallets = await prisma.wallet.findMany({
  where: { walletStatus: WalletStatus.ACTIVE },
  include: { user: { select: { name: true, email: true } } },
});
```

### Get Frozen Wallets (Admin)

```typescript
const frozenWallets = await prisma.wallet.findMany({
  where: { walletStatus: WalletStatus.FROZEN },
  include: { user: true },
  orderBy: { frozenAt: 'desc' },
});
```

---

## Edge Cases & Validation

### 1. Multiple User Wallets

**Rule**: One wallet per user (enforced by unique constraint).

**Validation**:

```typescript
// Unique constraint on (userId, walletType)
@@unique([userId, walletType])
```

### 2. Platform Wallet without User

**Rule**: Platform wallet must have `userId = null` and `walletCode = 'PLATFORM_MAIN'`.

**Validation**:

```typescript
if (walletType === WalletType.PLATFORM) {
  if (userId !== null || !walletCode) {
    throw new BadRequestException('Platform wallet validation failed');
  }
}
```

### 3. Wallet Balance Consistency

**Rule**: Balance must always match ledger entries sum.

**Periodic Audit**:

```typescript
async auditWalletBalances(): Promise<void> {
  const wallets = await prisma.wallet.findMany();

  for (const wallet of wallets) {
    const computed = await this.getBalance(wallet.id);
    const stored = wallet.balance; // If you had a stored field (YOU DON'T)

    // Since you don't store balance, this always passes
    // But good for logging/monitoring
    logger.info(`Wallet ${wallet.id}: Balance = ${computed}`);
  }
}
```

---

## Testing Guidelines

### Unit Tests

```typescript
describe('WalletService', () => {
  it('should create user wallet', async () => {
    const wallet = await service.createUserWallet(userId);
    expect(wallet.walletType).toBe(WalletType.USER);
  });

  it('should compute balance from ledger', async () => {
    // Create ledger entries: +100, -50, +25
    const balance = await service.getBalance(walletId);
    expect(balance).toEqual(new Decimal(75));
  });

  it('should freeze wallet correctly', async () => {
    await service.freezeWallet(walletId, 'Test', adminId);
    const wallet = await service.getWallet(walletId);
    expect(wallet.walletStatus).toBe(WalletStatus.FROZEN);
  });
});
```

---

## Troubleshooting

### Balance Not Updating

**Cause**: Looking for stored `balance` field (doesn't exist)

**Solution**: Always compute from ledger:

```typescript
const balance = await walletService.getBalance(walletId);
```

### Wallet Creation Fails

**Cause**: Duplicate `(userId, walletType)` combination

**Solution**: Check if wallet already exists:

```typescript
const existing = await prisma.wallet.findUnique({
  where: { userId_walletType: { userId, walletType } },
});
```

### Platform Wallet Not Found

**Cause**: Platform wallet not initialized

**Solution**: Run initialization script:

```typescript
await initializePlatformWallet();
```

---

**Last Updated**: January 1, 2026  
**Model Version**: Sprint 6A  
**Critical**: Balance is ALWAYS ledger-derived
